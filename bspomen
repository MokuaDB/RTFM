#!/usr/bin/env bash
# =====================================================================
# CachyOS AMD + NVIDIA (HP Omen Ryzen AI 7 + RTX 5070)
# Full automated BSPWM desktop + dev environment
# X11 ONLY – deterministic, reproducible, non-interactive
# =====================================================================

set -euo pipefail

# -----------------------------
# Global variables
# -----------------------------
USER_NAME="${SUDO_USER:-$USER}"
USER_HOME="$(getent passwd "$USER_NAME" | cut -d: -f6)"
CONFIG_DIR="$USER_HOME/.config"

# -----------------------------
# Safety checks
# -----------------------------
if [[ "$EUID" -ne 0 ]]; then
  echo "ERROR: This script must be run as root (sudo)."
  exit 1
fi

if ! ping -c 1 archlinux.org &>/dev/null; then
  echo "ERROR: No internet connection detected."
  exit 1
fi

echo "[OK] Running as root"
echo "[OK] Internet connection detected"

# =====================================================================
# BASE DEL SISTEMA
# =====================================================================
echo "==> Updating system and installing base packages"

pacman -Syu --noconfirm

pacman -S --noconfirm \
  base-devel \
  linux-headers \
  git \
  curl \
  wget \
  unzip \
  zip \
  xdg-user-dirs \
  networkmanager \
  bluez \
  bluez-utils \
  openssh \
  samba \
  nmap \
  tcpdump \
  qemu-full \
  virt-manager \
  dnsmasq \
  bridge-utils

systemctl enable NetworkManager
systemctl enable bluetooth
systemctl enable libvirtd

# =====================================================================
# NVIDIA / KERNEL (CRÍTICO)
# =====================================================================
echo "==> Installing NVIDIA drivers (CachyOS compatible)"

pacman -S --noconfirm \
  nvidia \
  nvidia-utils \
  nvidia-settings \
  lib32-nvidia-utils

# Disable nouveau
cat >/etc/modprobe.d/blacklist-nouveau.conf <<EOF
blacklist nouveau
options nouveau modeset=0
EOF

# NVIDIA DRM modeset
if ! grep -q "nvidia_drm.modeset=1" /etc/default/grub; then
  sed -i 's/GRUB_CMDLINE_LINUX="/GRUB_CMDLINE_LINUX="nvidia_drm.modeset=1 /' /etc/default/grub
fi

grub-mkconfig -o /boot/grub/grub.cfg
mkinitcpio -P

# X11 only (avoid Wayland conflicts)
mkdir -p /etc/environment.d
echo "XDG_SESSION_TYPE=x11" >/etc/environment.d/99-x11.conf

# =====================================================================
# X11
# =====================================================================
echo "==> Installing X11 stack"

pacman -S --noconfirm \
  xorg-server \
  xorg-xinit \
  xorg-xrandr \
  xorg-xsetroot \
  xorg-xinput \
  xorg-xauth \
  mesa \
  mesa-utils

# =====================================================================
# BSPWM + SXHKD
# =====================================================================
echo "==> Installing BSPWM environment"

pacman -S --noconfirm \
  bspwm \
  sxhkd \
  kitty \
  picom \
  rofi \
  dunst \
  thunar \
  thunar-archive-plugin \
  file-roller \
  nm-connection-editor \
  network-manager-applet \
  blueman \
  pipewire \
  pipewire-pulse \
  pipewire-alsa \
  wireplumber \
  pamixer \
  brightnessctl \
  feh

# =====================================================================
# UI / APPLICATIONS
# =====================================================================
pacman -S --noconfirm \
  firefox \
  obsidian \
  zsh \
  neovim

# Set ZSH as default shell
chsh -s /bin/zsh "$USER_NAME"

# =====================================================================
# DESARROLLO
# =====================================================================
pacman -S --noconfirm \
  python \
  python-pip \
  python-virtualenv \
  docker \
  docker-compose \
  pipx

systemctl enable docker
usermod -aG docker "$USER_NAME"

# =====================================================================
# CONFIG FILES
# =====================================================================
echo "==> Creating configuration files"

runuser -u "$USER_NAME" -- mkdir -p \
  "$CONFIG_DIR"/{bspwm,sxhkd,picom,kitty,rofi,dunst,nvim}

# -----------------------------
# ~/.xinitrc
# -----------------------------
cat >"$USER_HOME/.xinitrc" <<'EOF'
#!/bin/sh
exec bspwm
EOF
chown "$USER_NAME":"$USER_NAME" "$USER_HOME/.xinitrc"
chmod +x "$USER_HOME/.xinitrc"

# -----------------------------
# BSPWM
# -----------------------------
cat >"$CONFIG_DIR/bspwm/bspwmrc" <<'EOF'
#!/bin/sh
pgrep -x sxhkd >/dev/null || sxhkd &
picom &
nm-applet &
blueman-applet &
dunst &
bspc monitor -d I II III IV V VI VII VIII IX X
bspc config border_width 2
bspc config window_gap 10
bspc config focus_follows_pointer true
EOF
chmod +x "$CONFIG_DIR/bspwm/bspwmrc"

# -----------------------------
# SXHKD
# -----------------------------
cat >"$CONFIG_DIR/sxhkd/sxhkdrc" <<'EOF'
super + Return
	kitty

super + d
	rofi -show drun

super + q
	bspc node -c

super + Escape
	bspc quit
EOF

# -----------------------------
# Picom (NVIDIA-safe)
# -----------------------------
cat >"$CONFIG_DIR/picom/picom.conf" <<'EOF'
backend = "glx";
vsync = true;
unredir-if-possible = false;
use-damage = true;
EOF

# -----------------------------
# Kitty
# -----------------------------
cat >"$CONFIG_DIR/kitty/kitty.conf" <<'EOF'
font_family monospace
font_size 11
enable_audio_bell no
EOF

# -----------------------------
# Rofi
# -----------------------------
cat >"$CONFIG_DIR/rofi/config.rasi" <<'EOF'
configuration {
  modi: "drun";
  show-icons: true;
}
EOF

# -----------------------------
# Dunst
# -----------------------------
cat >"$CONFIG_DIR/dunst/dunstrc" <<'EOF'
[global]
geometry = "300x5-10+10"
frame_width = 2
EOF

# -----------------------------
# ZSH + Oh My Zsh
# -----------------------------
runuser -u "$USER_NAME" -- bash <<'EOF'
if [ ! -d "$HOME/.oh-my-zsh" ]; then
  RUNZSH=no CHSH=no sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)"
fi

git clone https://github.com/zsh-users/zsh-autosuggestions ~/.oh-my-zsh/custom/plugins/zsh-autosuggestions || true
git clone https://github.com/zsh-users/zsh-syntax-highlighting ~/.oh-my-zsh/custom/plugins/zsh-syntax-highlighting || true
EOF

cat >"$USER_HOME/.zshrc" <<'EOF'
export ZSH="$HOME/.oh-my-zsh"
ZSH_THEME="robbyrussell"
plugins=(git zsh-autosuggestions zsh-syntax-highlighting)
source $ZSH/oh-my-zsh.sh
EOF
chown "$USER_NAME":"$USER_NAME" "$USER_HOME/.zshrc"

# -----------------------------
# Neovim (Lua, LSP, Treesitter)
# -----------------------------
cat >"$CONFIG_DIR/nvim/init.lua" <<'EOF'
require("lazy").setup({
  {"neovim/nvim-lspconfig"},
  {"nvim-treesitter/nvim-treesitter", build=":TSUpdate"},
  {"nvim-telescope/telescope.nvim", dependencies={"nvim-lua/plenary.nvim"}},
  {"windwp/nvim-autopairs"},
  {"lewis6991/gitsigns.nvim"}
})

require("lspconfig").pyright.setup({})
require("lspconfig").lua_ls.setup({})
EOF

# =====================================================================
# FINAL
# =====================================================================
echo "====================================================="
echo "INSTALLATION COMPLETE"
echo "====================================================="
echo
echo "POST-INSTALL:"
echo "1) Reboot the system"
echo "2) Login on TTY"
echo "3) Run: startx"
echo
echo "VERIFY:"
echo "  nvidia-smi"
echo "  glxinfo | grep NVIDIA"
echo
echo "CACHYOS NOTES:"
echo "- X11 only (no Wayland)"
echo "- NVIDIA DRM modeset enabled"
echo "- BSPWM is default session"
echo
echo "DONE."
